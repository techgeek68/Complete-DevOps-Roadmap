# Maven

Maven is a powerful open-source build automation tool widely used in DevOps to streamline the software development lifecycle, especially for Java projects. It offers features like dependency management, build lifecycle management, and plugin support, enabling efficient, consistent, and automated build and deployment processes.

## Key Roles of Maven

- Declarative, consistent builds:
  Maven’s `pom.xml` defines your project’s build so it runs the same way everywhere.
- Automated dependency management:
  It downloads and locks library versions for you, avoiding manual JAR handling.
- Opinionated project layout:
  A fixed directory structure keeps source code, tests, and resources in predictable places.
- Lifecycle automation via plugins:
  Standard phases—`validate`, `compile`, `test`, `package`, `verify`, `install`, `deploy`—are wired to plugins so you don’t write custom scripts.
- Versioned artifact production:
  Each build outputs a uniquely versioned JAR or WAR ready for deployment.

## Importance in DevOps

- CI/CD enabler:
  Integrates with Jenkins, GitLab CI, GitHub Actions, etc., to run builds, tests, and packaging automatically.
- Reproducibility:
  Locked dependencies and standardized builds eliminate “it works on my machine” problems.
- Faster feedback & delivery:
  Plugin‑driven workflows accelerate the build → test → package cycle.
- Seamless integrations:
  Hooks into Nexus/Artifactory, scanners, and deployment tools out of the box.
- Team consistency:
  A single `pom.xml` means everyone shares the same build contract.

## Common Maven commands

```
mvn clean                 # Delete 'target' directory (build outputs)
mvn compile               # Compile source code
mvn test                  # Run unit tests
mvn package               # Compile, test, and produce JAR/WAR in 'target/'
mvn verify                # Run any checks to verify the package is valid
mvn install               # Install artifact to local ~/.m2/repository
mvn deploy                # Deploy artifact to remote repo (e.g., Nexus/Artifactory)
mvn dependency:tree       # View dependency tree
```

Useful flags:

```
mvn -DskipTests package       # Skip test execution (compile tests still occur)
mvn -DskipITs verify          # Skip integration tests (when configured)
mvn -T 1C package             # Build with 1 thread per core
mvn -U clean package          # Force update of snapshot dependencies
```

---

# Installing and Configuring Apache Maven

These steps assume a Fedora/RHEL/CentOS system using `dnf`. Adjust for your distro as needed.

## Prerequisites: Java (JDK 11+)

- Create a VM named `developer` (as per your lab/notes).
- Install Java and verify version:

```
sudo dnf list | grep jdk
sudo dnf -y install java-21-openjdk java-21-openjdk-devel
java -version
```

Optional: discover JDK path and set `JAVA_HOME`.

```
cd /usr/lib/jvm
ls
cd java-21-openjdk
pwd
# Example output: /usr/lib/jvm/java-21-openjdk
```

Set `JAVA_HOME` system-wide (or use `~/.bashrc` for per-user):

```
sudo vi /etc/profile
# Add:
export JAVA_HOME=/usr/lib/jvm/java-21-openjdk
export PATH="$PATH:$JAVA_HOME/bin"
```

Apply changes and verify:

```
source /etc/profile
echo $JAVA_HOME
which java
```

## Download and Install Maven

Option A: Use distro package (may not be the latest):

```
sudo dnf info maven
sudo dnf -y install maven
mvn -version
```

Option B: Use the latest binary from Apache (example: 3.9.10):

```
cd /opt
sudo mkdir -p maven
cd maven
sudo wget https://dlcdn.apache.org/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz
sudo tar -zxvf apache-maven-3.9.10-bin.tar.gz
```

Set `M2_HOME` and update `PATH`:

```
sudo vi /etc/profile
# Add:
export M2_HOME=/opt/maven/apache-maven-3.9.10
export PATH="$PATH:$M2_HOME/bin"
```

Refresh and verify:

```
source /etc/profile
echo $M2_HOME
which mvn
mvn --version
```

Note: The `mvn` file is a shell script that sets up the environment and launches Maven’s core Java class.

---

# Create a Java-based application using Maven

```
mkdir -p /home/cnode/javaapp
cd /home/cnode/javaapp
```

## Step 1: Create a project structure (WebApp example)

```
mvn archetype:generate \
  -DgroupId=com.devopsclass \
  -DartifactId=sample-app \
  -DarchetypeArtifactId=maven-archetype-webapp \
  -DinteractiveMode=false
```

Inspect structure:

```
tree sample-app
```

Then:

```
cd sample-app
ls
# Expect: pom.xml  src/
ls src/main/webapp
# Expect: index.jsp (you can edit)
```

### Explanation: Maven project creation

- Command:

```
mvn archetype:generate
```

- Parameters:

```
-DgroupId=com.example                 # Defines base package (reverse-domain)
-DartifactId=sample-app               # Project name and root directory
-DarchetypeArtifactId=maven-archetype-webapp  # Web application (WAR)
-DinteractiveMode=false               # Skip interactive prompts
```

Common archetypes:

```
maven-archetype-quickstart    # Simple Java project (JAR)
maven-archetype-webapp        # Basic web application (WAR)
```

Framework-specific tips:

- Spring Boot: Typically generated via Spring Initializr rather than Maven archetypes.

```
curl https://start.spring.io/starter.zip -d type=maven-project \
  -d language=java -d bootVersion=3.3.4 -d groupId=com.example \
  -d artifactId=demo -d name=demo -d packaging=jar -d javaVersion=21 \
  -d dependencies=web -o demo.zip
unzip demo.zip -d .
```

- Quarkus (via Maven plugin):

```
mvn io.quarkus:quarkus-maven-plugin:3.15.0:create \
  -DprojectGroupId=com.example -DprojectArtifactId=quarkus-app \
  -DclassName="com.example.GreetingResource" -Dpath="/hello"
```

---

# SDLC quick view

Requirements → Design → Implementation → Testing → Deployment → Maintenance & Operations

Maven supports the Implementation, Testing, Packaging, and Release/Deployment stages with consistent, repeatable builds and integrations to CI/CD.

---

# The pom.xml

`pom.xml` (Project Object Model) is the core configuration file for Maven projects. It defines project metadata, dependencies, build plugins, and more.

Minimal `pom.xml` for a simple webapp (WAR):

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.devopsclass</groupId>
  <artifactId>sample-app</artifactId>
  <version>1.0.0</version>
  <packaging>war</packaging>

  <name>sample-app</name>
  <description>Sample web application built with Maven</description>

  <properties>
    <maven.compiler.release>21</maven.compiler.release>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>

  <dependencies>
    <!-- Example: JSP/Servlet APIs are provided by the container (Tomcat/Jetty) -->
    <dependency>
      <groupId>jakarta.servlet</groupId>
      <artifactId>jakarta.servlet-api</artifactId>
      <version>6.0.0</version>
      <scope>provided</scope>
    </dependency>
    <!-- Example test dependency -->
    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter</artifactId>
      <version>5.10.3</version>
      <scope>test</scope>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <!-- Ensure JUnit 5 tests run -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.5.1</version>
        <configuration>
          <useModulePath>false</useModulePath>
        </configuration>
      </plugin>

      <!-- Optional: Run locally with Jetty during development -->
      <plugin>
        <groupId>org.eclipse.jetty</groupId>
        <artifactId>jetty-maven-plugin</artifactId>
        <version>12.0.10</version>
      </plugin>
    </plugins>
  </build>
</project>
```

Example `src/main/webapp/index.jsp`:

```jsp
<%@ page contentType="text/html; charset=UTF-8" %>
<!DOCTYPE html>
<html>
<head><title>Sample App</title></head>
<body>
  <h1>Hello from Maven WebApp!</h1>
  <p>Deployed with Tomcat/Jetty. Version: 1.0.0</p>
</body>
</html>
```

---

# Compiling and Packaging

Run inside the project directory where `pom.xml` resides. Maven will download required plugins and cache them in `~/.m2/repository`.

Compile:

```
mvn compile
```

Package:

```
mvn package
```

Check outputs:

```
ls target
# Expect a .war file for webapps, e.g., target/sample-app-1.0.0.war
```

Run locally with Jetty (optional; requires jetty plugin):

```
mvn jetty:run
# Visit http://localhost:8080/sample-app/
```

---

# Deploying the WAR to Tomcat

Assuming:
- Tomcat server is powered on and accessible.
- Developer machine has built `target/sample-app.war`.
- Tomcat’s `webapps/` directory is on the remote host.
- Default Tomcat HTTP connector is 8080 unless you reconfigured.

Copy WAR via `scp`:

```
cd /home/cnode/javaapp/sample-app/target
ls
# sample-app.war
scp sample-app.war cnode@10.10.5.9:~/apache-tomcat-9.0.106/webapps
```

Access the app in a browser (adjust port/context path if configured differently):

```
http://10.10.5.9:8080/sample-app/
# If your Tomcat uses port 5080 per your setup:
# http://10.10.5.9:5080/sample-app/
```

Make changes and redeploy:

```
# On developer machine
cd /home/cnode/javaapp/sample-app/src/main/webapp
sudo vim index.jsp
# ...change the content...

cd ../../../
mvn package
cd target
scp sample-app.war cnode@10.10.5.9:~/apache-tomcat-9.0.106/webapps
```

---

# Useful Maven Concepts (cheat-sheet)

Dependency scopes:

```
compile   # Default; available everywhere (prod + test)
provided  # Provided by container/JDK (e.g., servlet-api in Tomcat)
runtime   # Needed at runtime but not compile-time
test      # Only available on test classpath
system    # Similar to 'provided' but requires explicit local path (rare)
```

Profiles (activate custom settings):

```xml
<profiles>
  <profile>
    <id>prod</id>
    <properties>
      <app.env>production</app.env>
    </properties>
    <activation>
      <property>
        <name>env</name>
        <value>prod</value>
      </property>
    </activation>
  </profile>
</profiles>
```

Activate:

```
mvn package -Pprod
mvn package -Denv=prod
```

Maven Wrapper (pin Maven version per project):

```
mvn -N io.takari:maven:wrapper
# Then use:
./mvnw -version
./mvnw clean package
```

Check updates:

```
mvn versions:display-dependency-updates
mvn versions:display-plugin-updates
```

---

# CI/CD Example (Jenkins Pipeline)

Jenkinsfile example:

```groovy
pipeline {
  agent any
  tools { maven 'Maven-3.9'  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Build') {
      steps { sh 'mvn -B -U clean package' }
    }
    stage('Test') {
      steps { sh 'mvn test' }
      post {
        always { junit 'target/surefire-reports/*.xml' }
      }
    }
    stage('Publish to Nexus') {
      when { branch 'main' }
      steps { sh 'mvn -B deploy -DskipTests' }
    }
  }
  post {
    always { archiveArtifacts artifacts: 'target/*.war', fingerprint: true }
  }
}
```

---

# settings.xml tips (mirrors, credentials, proxies)

User-level file: `~/.m2/settings.xml`

Mirror to a Nexus/Artifactory:

```xml
<settings>
  <mirrors>
    <mirror>
      <id>corp-nexus</id>
      <name>Corporate Nexus</name>
      <url>https://nexus.example.com/repository/maven-group/</url>
      <mirrorOf>central</mirrorOf>
    </mirror>
  </mirrors>

  <servers>
    <server>
      <id>corp-nexus</id>
      <username>${env.NEXUS_USER}</username>
      <password>${env.NEXUS_PASS}</password>
    </server>
  </servers>
</settings>
```

Set a proxy (if needed):

```xml
<settings>
  <proxies>
    <proxy>
      <id>corp-proxy</id>
      <active>true</active>
      <protocol>http</protocol>
      <host>proxy.example.com</host>
      <port>3128</port>
      <nonProxyHosts>localhost|127.0.0.1|*.example.com</nonProxyHosts>
    </proxy>
  </proxies>
</settings>
```

---

# .gitignore for Maven projects

```
target/
.settings/
.classpath
.project
*.iml
.idea/
.mvn/wrapper/maven-wrapper.jar
```

---

# Troubleshooting

```
mvn: command not found
# Ensure PATH includes Maven bin and restart your shell/session.

JAVA_HOME is not set
# Set JAVA_HOME and ensure it points to a JDK (not just a JRE).

Tests fail locally but pass in CI (or vice versa)
# Check JDK versions and OS-specific differences; pin tool versions in pom.xml.

Port already in use when running Jetty/Tomcat
# Change connector port or stop the conflicting process.
```

---

# Quick reference

Commands:

```
mvn clean
mvn compile
mvn test
mvn package
mvn install
mvn dependency:tree
```

SCP deploy (example):

```
scp sample-app.war cnode@10.10.5.9:~/apache-tomcat-9.0.106/webapps
```

URLs:

```
http://10.10.5.9:8080/sample-app/
# or if configured:
http://10.10.5.9:5080/sample-app/
```
