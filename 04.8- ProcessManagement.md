# 12. Process Management, System Monitoring, and Performance Tuning

This section covers essential process management and system monitoring for DevOps engineers. It includes practical commands, tool usage, resource limits, troubleshooting, best practices for Linux systems, cloud/enterprise contexts, and advanced/enterprise integrations.

---

## 12.1 Process Management

**A. Process Monitoring Tools**

**`ps` (Process Status)**
- List all running processes (BSD-style):  
  ```bash
  ps aux
  ```
- List all processes (Unix-style):  
  ```bash
  ps -ef
  ```
- Show processes for a specific user:  
  ```bash
  ps -u <user>
  ps -u root
  ```
  
**Key Columns:**  
- PID (Process ID)
- %CPU (CPU usage)
- %MEM (Memory usage)
- COMMAND (Process command)

**`top`**
- Interactive, real-time process viewer:
  ```bash
  top
  ```
  
**Actions in top:**
- `k`: Kill a process (enter PID)
- `M`: Sort by memory usage
- `P`: Sort by CPU usage
- `q`: Quit

**`htop`**
- Improved interactive process viewer with color and tree view.
- **Install:**  
  ```bash
  sudo dnf install epel-release -y
  sudo dnf install htop -y
  ```
- **Run:**  
  ```bash
  htop
  ```
**Features:**  
- Tree view (F5)
- Sort columns (F6)
- Kill processes (F9)


> Use `htop` for intuitive resource usage and process tree visualization.

---

**B. Managing Background Jobs**

- **Start a background job:**  
  ```bash
  sleep 60 &
  ```
  Output: `[1] 12345` (job ID 1, PID 12345)
- **List jobs:**  
  ```bash
  jobs
  ```
- **Suspend foreground job:**  
  Press `Ctrl + Z`
- **Resume in background:**  
  ```bash
  bg %1
  ```
- **Bring to foreground:**  
  ```bash
  fg %1
  ```

> Manage long-running or interactive tasks using job control. Always check with `jobs`.

---

**C. Process Signals**

- Signals are software interrupts for processes.
- **Common Signals:**
  | Signal Name | Number | Description                    |
  |-------------|--------|--------------------------------|
  | SIGHUP      | 1      | Hangup (reload config)         |
  | SIGINT      | 2      | Interrupt (Ctrl+C)             |
  | SIGKILL     | 9      | Force termination (cannot ignore)|
  | SIGTERM     | 15     | Graceful termination (default) |

**Send signals:**
- **Force-kill process:**  
  ```bash
  kill -9 12345
  ```
- **Graceful termination:**  
  ```bash
  kill -15 12345
  ```
- **Kill all by name:**  
  ```bash
  killall -9 process_name
  pkill firefox
  ```

**Process Types:**
- **Zombie:** Finished, entry remains; usually harmless.
- **Orphan:** Parent died, adopted by init (PID 1).

 
> Prefer `SIGTERM` (15) over `SIGKILL` (9) for cleanup. Use tree view (`htop`, `pstree`) to avoid killing critical processes.


---


## 13.1 System Monitoring and Performance Tuning

**A. Monitoring System Performance**

**`vmstat` (Virtual Memory Statistics)**
- Overview: virtual memory, processes, CPU, I/O.
- **Run:**  
  ```bash
  vmstat 1
  ```
  (Updates every 1 second)
- **Key metrics:**  
  - `r`: Running processes
  - `b`: Uninterruptible sleep
  - `free`: Free memory
  - `si/so`: Swap in/out
  - `wa`: I/O wait

**`iostat` (I/O Statistics)**
- **Install:**  
  ```bash
  sudo dnf install sysstat -y
  ```
- **Run:**  
  ```bash
  iostat
  ```
  (Displays CPU and device I/O usage)

**`sar` (System Activity Reporter)**
- **Install:**  
  ```bash
  sudo dnf install sysstat -y
  ```
- **Run:**  
  ```bash
  sar
  ```
  (Historical and real-time performance data)

**`free` (Memory Usage)**
- **Run:**  
  ```bash
  free -h
  ```
  (Human-readable RAM and swap usage)

**`htop` (Real-Time Monitoring)**
- Color-coded metrics: CPU, memory, swap.
- Sort: F6 (by CPU%, MEM%, user)
- Kill: F9
- Tree: F5


> Use `htop` for interactive and visual monitoring; combine with `vmstat`, `iostat`, `sar` for deep analysis.

---

**B. Setting Resource Limits**

**`ulimit`**
- Limit resources for the current shell/process.
- **Check limits:**  
  ```bash
  ulimit -a
  ```
- **Set file descriptor limit:**  
  ```bash
  ulimit -n 4096
  ```
- **Set max user processes:**  
  ```bash
  ulimit -u 2048
  ```

**Persistent Limits**
- Set in `/etc/security/limits.conf`:
  ```
  username soft nofile 4096
  username hard nofile 8192
  ```

**`cgroups` (Control Groups)**
- Kernel feature for resource isolation.
- **Create cgroup with limited memory:**
  ```bash
  sudo cgcreate -g memory:/mygroup
  sudo cgset -r memory.limit_in_bytes=256M mygroup
  sudo cgexec -g memory:/mygroup ./myprocess
  ```
- In containers/Kubernetes, resource limits (`resources.requests`/`resources.limits`) are set in pod specs.

**Advanced cgroups (v2) and systemd resource slices**
- **cgroup v2** offers the unified hierarchy and better resource control.
- **systemd slices**: Used to group and limit system services.
  - Example: Configure service limits in `/etc/systemd/system/myservice.service`
    ```
    [Service]
    CPUQuota=50%
    MemoryMax=256M
    ```
  - Place services into slices for isolation:
    ```
    [Unit]
    Slice=custom.slice
    ```

> Always set sensible resource limits for production processes to avoid system exhaustion. Use cgroup v2 and systemd slices for fine-grained control in modern systems.

---

## 13.2 Troubleshooting & Examples

| Symptom            | Diagnostic Command      | Likely Cause             | Resolution                   |
|--------------------|------------------------|--------------------------|------------------------------|
| High CPU usage     | `top`, `htop`          | Runaway process          | Kill, restart, tune process  |
| Memory exhaustion  | `free -h`, `htop`      | Memory leak, swap usage  | Kill, limit, add RAM         |
| IO bottleneck      | `iostat`, `vmstat`     | Disk saturation          | Optimize IO, SSD, tune app   |
| Process crashed    | `ps`, `journalctl`     | Segfault, OOM, SIGKILL   | Check logs, restart process  |
| Zombie processes   | `ps aux | grep Z`      | Defunct child processes  | Usually self-cleaning        |

---

## 13.3 Cloud/Container & Enterprise Monitoring Integrations

**A. Enterprise Monitoring**

- **Prometheus**:  
  - Time-series database, collects metrics via exporters.
  - Integrate with **Grafana** for dashboards and alerting.
  - Example:
    ```bash
    # Query Prometheus for CPU usage
    avg(rate(process_cpu_seconds_total[5m]))
    ```
  - Visualize and set alerts in Grafana.

- **New Relic / Datadog / Splunk**:  
  - Agents installed on hosts/containers.
  - Application and infrastructure metrics, traces, and logs.
  - Dashboards, alerting, anomaly detection.
  - Cloud platform integrations for deep visibility.

 
> Centralize monitoring using enterprise platforms. Use labels/tags for environments and automate dashboard/report generation.

---

**B. Automated Alerting and Remediation**

- Monitor resource usage and process health.
- **Automated Scripts/Ansible**:
  - Trigger remediation scripts on alert (restart services, scale resources).
- **PagerDuty Integration**:
  - Connect monitoring tools to PagerDuty for incident escalation.
- **Example workflow**:
  - Prometheus alert triggers webhook → Ansible playbook restarts service or scales deployment.
  - Datadog detects anomaly → sends alert to PagerDuty → Ops on-call notified.


> Automate remediation for known failure scenarios. Always run playbooks/scripts with logging and dry-run mode for safety.

---

**C. Application-Level Monitoring (APM)**

- **APM tools** (New Relic, Datadog, Splunk, Elastic APM):
  - Instrument applications for response time, error rate, and transaction traces.
  - Identify code-level bottlenecks and slow queries.
  - Integrate with CI/CD pipelines for release monitoring.


> Instrument all critical applications and services. Set up alerting for latency/error thresholds.

---

### D. **Advanced Container Orchestration Metrics**

- **Kubernetes Horizontal Pod Autoscaler (HPA)**:
  - Automatically scales pods based on CPU/memory/custom metrics.
  - Example spec:
    ```yaml
    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    metadata:
      name: web-hpa
    spec:
      scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: web
      minReplicas: 2
      maxReplicas: 10
      metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 60
    ```
- **Node Autoscaling:**
  - Cloud providers support autoscaling clusters based on resource demand.
  - Integrate monitoring tools to trigger scale operations.


> Always define resource requests/limits for containers. Use HPA and node autoscaling for resilient, cost-effective infrastructure.

---

## 13.4 Security & Best Practices

| Area         | Recommendation                                                        |
|--------------|-----------------------------------------------------------------------|
| Process kill | Prefer SIGTERM, avoid SIGKILL unless necessary                        |
| Monitoring   | Combine multiple tools for full system insight                        |
| Limits       | Always set ulimit and cgroups/resource limits for critical services   |
| Visualization| Use color/tree view with htop for clarity                            |
| Automation   | Monitor resource usage and auto-restart unhealthy services            |
| Cloud        | Integrate with cloud-native and enterprise monitoring/alerting tools  |
| APM          | Instrument apps for code-level monitoring and error tracking          |
| Orchestration| Use HPA and node autoscaling for scalable workloads                   |

---


## 13.5 References (Suggested Further Study)

- `man ps`, `man top`, `man htop`, `man kill`, `man pkill`, `man killall`
- `man vmstat`, `man iostat`, `man sar`, `man free`
- `man ulimit`, `man cgroups`
- [Linux Process Management](https://tldp.org/LDP/Linux-Filesystem-Hierarchy/html/proc.html)
- [htop](https://htop.dev/)
- [Kubernetes Resource Management](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/)
- [Kubernetes HPA](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)
- [Prometheus](https://prometheus.io/docs/introduction/overview/)
- [Grafana](https://grafana.com/docs/)
- [New Relic](https://docs.newrelic.com/docs/apm/)
- [Datadog Infrastructure Monitoring](https://docs.datadoghq.com/infrastructure/)
- [Splunk Observability](https://docs.splunk.com/Documentation/Observability)
- [Elastic APM](https://www.elastic.co/guide/en/apm/get-started/current/overview.html)
- [AWS CloudWatch](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/WhatIsCloudWatch.html)
- [Azure Monitor](https://learn.microsoft.com/en-us/azure/azure-monitor/)
- [GCP Monitoring](https://cloud.google.com/monitoring/docs)

---
