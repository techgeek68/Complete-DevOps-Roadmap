# 14. Remote Login Using SSH, Security, and Security Hardening

This section covers secure remote access with SSH, key-based authentication, file transfer, and system hardening practices for DevOps engineers. It also covers more advanced configuration, automation, firewall, sudo, password policies, best practices for Linux/cloud/enterprise environments, and other advanced and enterprise topics.

---

## 14.1 Configuring SSH for Secure Remote Access

SSH (Secure Shell) is a protocol for securely accessing and managing computers over a network. It was created to replace insecure protocols like Telnet and FTP by encrypting all data.

Features:
  - Security: Encrypts all communication to protect against attacks.
  - Authentication: Verifies users with passwords or, more securely, cryptographic keys.
  - Default Port: Operates on TCP port 22.
    
Process:
  - Open a terminal and run the command: ssh username@server_ip
  - Accept the server's host fingerprint on the first connection.
  - Authenticate with your password or SSH key.
  - Once connected, you can run commands on the remote machine.
  - Type exit to end the session.

**Prerequisites**
- You need two systems to connect between. You can:
  - Create two VMs: Web Server and Web Developer.
  - Example:
      vm1: DevOps-Linux-CLI (IPv4: 10.10.5.4)
      vm2: DevOps_Linux-GUI
  - Or, simply create two users on one VM.
  

Execute the following on the 'DevOps_Linux-GUI' VM (vm2):
```bash
  mkdir sshtest
```
```
  cd sshtest
```
```
  vim index.html
    <h1> testing SSH connection </h1>
```

**A. Basic SSH Connection**

- **Linux/MacOS:** Pre-installed. Use `ssh` in terminal.
- **Windows:** OpenSSH (Windows 10/11), or [PuTTY](https://www.putty.org/) for older versions.

**Basic SSH Connection:**
```bash
# Default port (22)
  ssh username@remote_host
            or
  ssh username@server_IP 

# Custom port
  ssh -p 2222 username@remote_host 
              or
  ssh -p 2222 username@server_IP
```


**SSH Server Configuration (/etc/ssh/ssh_config):**

  ```
# Change default port
Port 2222

# Security settings
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AllowUsers alice bob charlie
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
  ```

**SELinux & Firewall Configuration**

```bash
# Register custom SSH port with SELinux
sudo semanage port -a -t ssh_port_t -p tcp 2222

# Firewall rules
sudo firewall-cmd --permanent --add-port=2222/tcp
sudo firewall-cmd --reload

# Reload SSH service
sudo systemctl reload sshd
```

Connect:
    ```bash
    ssh -p 2222 user@remote_host_IP
    ```

**B. SSH Client Configuration (~/.ssh/config)**

Example:
```
Host webserver
    HostName 192.168.1.100
    User admin
    Port 2222
    IdentityFile ~/.ssh/webserver_key

Host bastion
    HostName bastion.example.com
    User jumpuser
    Port 2222

Host internal-server
    HostName 10.0.1.50
    User admin
    ProxyJump bastion
    
Host db-tunnel
    HostName db.example.com
    LocalForward 3306 127.0.0.1:3306
```

- Connect with:
```bash
    ssh testserver
```

---

**14.2 Key-Based Authentication**

- Generate SSH Keys:
```bash
# Modern (Recommended)
ssh-keygen -t ed25519 -a 100 -C "user@hostname" -f ~/.ssh/id_ed25519

# RSA (Legacy)
ssh-keygen -t rsa -b 4096 -C "user@hostname" -f ~/.ssh/id_rsa
  ```
  - `-a 100`: Key derivation rounds for brute-force resistance

**Keys Stored Location:**
- Private: `~/.ssh/id_ed25519`
- Public: `~/.ssh/id_ed25519.pub`


**Secure Key Permissions:**
```
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519
chmod 644 ~/.ssh/id_ed25519.pub
chmod 644 ~/.ssh/authorized_keys
chmod 644 ~/.ssh/config
```

**SSH Agent Management**
```
# Start agent
eval "$(ssh-agent -s)"

# Add key to agent
ssh-add ~/.ssh/id_ed25519

# List loaded keys
ssh-add -l

# Remove all keys
ssh-add -D
```

**Deploy Public Key:**
```bash
# Automatic copy
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@remote_host

# Manual method
cat ~/.ssh/id_ed25519.pub | ssh user@remote_host "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```


**Disable Password Authentication (on server):**
Edit `/etc/ssh/sshd_config`:
```
PasswordAuthentication no
ChallengeResponseAuthentication no
UsePAM no
```

Reload SSH:
```bash
sudo systemctl reload sshd
```

**Connect Using Key:**
```bash
ssh -i ~/.ssh/id_ed25519 username@remote_server_ip
```


---

**14.3 File Transfers Over SSH**

**A. SCP (Secure Copy)**
  ```bash
#Local to remote
scp -P 2222 /local/file.txt user@remote:/path/

#Remote to local  
  scp -P 2222 user@remote:/path/file.txt /local/

#Recursive directory copy
  scp -r /local/dir/ user@remote:/path/

#Custom port
  ```bash
  scp -P 2222 /local/dir username@remote_server_ip:/path

#Preserve attributes
  scp -p /local/file user@remote:/path/
  ```

**B. RSync Over SSH**

```bash
# Basic sync
rsync -avz /local/dir/ user@remote:/remote/dir/

# Sync with delete (mirror)
rsync -avz --delete /local/dir/ user@remote:/remote/dir/

# Custom SSH port
rsync -avz -e "ssh -p 2222" /local/dir/ user@remote:/remote/dir/

# Partial transfers (resume)
rsync -avz --partial /large/file user@remote:/path/

# Bandwidth limiting
rsync -avz --bwlimit=1000 /local/ user@remote:/remote/
```
- **Flags:**
  - `-a`: Archive mode
  - `-v`: Verbose
  - `-z`: Compress
  - `-e`: Specify remote shell/port

**SSHFS (SSH Filesystem)**

```bash
# Mount remote directory
sshfs user@remote:/remote/path /local/mountpoint -p 2222

# Unmount
fusermount -u /local/mountpoint

# Persistent mount (/etc/fstab)
sshfs#user@remote:/path /local/mountpoint fuse.sshfs port=2222,defaults 0 0
```

**15.1 Security and Hardening**

A. SSH Hardening

Edit `/etc/ssh/sshd_config`:
```
#Disable Root Login:
  PermitRootLogin no
  
#Change Default Port:**
  Port 2222

#Limit Allowed Users:
  AllowUsers alice bob
```

**SSH Hardening Script**
```
#!/bin/bash
# ssh-hardening.sh

# Backup original config
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)

# Apply security settings
cat > /etc/ssh/sshd_config << EOF
Port 2222
Protocol 2
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AllowUsers alice bob
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
LoginGraceTime 60
AllowTcpForwarding no
X11Forwarding no
PrintMotd no
IgnoreRhosts yes
RhostsRSAAuthentication no
HostbasedAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
AllowAgentForwarding no
EOF

# Reload SSH
systemctl reload sshd
echo "SSH hardening completed"
```

**Fail2Ban Configuration (anti-brute-force):**   

- Monitors logs and bans IPs with suspicious activity.

```
# Install
sudo apt install fail2ban  # Debian/Ubuntu
sudo dnf install fail2ban  # RHEL/CentOS

# SSH jail configuration (/etc/fail2ban/jail.local)
[sshd]
enabled = true
port = 2222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600

# Start and enable
sudo systemctl enable --now fail2ban
sudo fail2ban-client status sshd
```

---

**B. Firewall Configuration**

**Allow SSH (custom port):**

```bash
# UFW (Ubuntu)
sudo ufw allow 2222/tcp
sudo ufw deny 22/tcp
sudo ufw enable

# firewalld (RHEL/CentOS)
sudo firewall-cmd --permanent --add-port=2222/tcp
sudo firewall-cmd --permanent --remove-service=ssh
sudo firewall-cmd --reload

# iptables (Legacy)
iptables -A INPUT -p tcp --dport 2222 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP
iptables-save > /etc/iptables/rules.v4
```

**Password Policy Enforcement**
```
# Install PAM module
sudo apt install libpam-pwquality    # Debian/Ubuntu
sudo dnf install libpwquality        # RHEL/CentOS

# Configure (/etc/security/pwquality.conf)
minlen = 12
minclass = 3
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
maxrepeat = 2
```

**Sudo Security**
```
# Edit sudoers safely
sudo visudo

# Example entries
# User with full access
alice ALL=(ALL:ALL) ALL

# User with specific commands
bob ALL=(ALL) /usr/bin/systemctl restart nginx, /usr/bin/systemctl status nginx

# Group-based access
%admins ALL=(ALL) ALL

# Passwordless for specific commands
%backup ALL=(ALL) NOPASSWD: /usr/bin/rsync

# Log all sudo commands
Defaults logfile="/var/log/sudo.log"
```

---



**Advanced/Enterprise Enhancements**

### A. Bastion Host / Jump Host Setup

- Use a dedicated bastion host as a secure entry point to private servers in multi-tier environments.
- Restrict SSH access to production/internal servers from outside only via the bastion.
- Example `/etc/ssh/sshd_config` for bastion:
  ```
  AllowTcpForwarding yes
  PermitTunnel yes
  ```
- Use ProxyJump/ProxyCommand in `~/.ssh/config`:
  ```bash
  Host internal
    HostName 10.0.0.10
    User admin
    ProxyJump bastion-host
  ```
  or
  ```bash
  ssh -J bastion-host internal
  ```
- Harden bastion: restrict IPs, enforce key-based auth, enable logging/auditing.

### B. Automated SSH Certificate Authorities (CA)

- Use OpenSSH CA to issue short-lived certificates for users/hosts.
- Benefits: central control, key rotation, short-lived credentials.
- Example to sign a user key:
  ```bash
  ssh-keygen -s /path/to/ca_key -I user -n username -V +1h ~/.ssh/id_ed25519.pub
  ```
- Add CA public key to `/etc/ssh/sshd_config`:
  ```
  TrustedUserCAKeys /etc/ssh/ca.pub
  ```
- Automate with Vault, Teleport, or AWS IAM SSH certificates.

### C. Cloud-Native SSH Session Auditing

- **AWS:** Use [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html) for shell access with audit logs and no direct SSH port exposure.
- **Azure:** Use [Azure Bastion](https://learn.microsoft.com/en-us/azure/bastion/bastion-overview) for secure, audited SSH/RDP.
- **GCP:** Use [IAP TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding) and OS Login for SSH session logging.

_Best Practice:_  
Prefer cloud-native session management for audit/compliance and no key management.

### D. Advanced PAM Modules for SSH Restriction

- Use PAM modules to restrict SSH sessions by time, IP, user, or MFA.
- Example for time-based restrictions:
  - Edit `/etc/security/time.conf`
- Example for multi-factor authentication:
  - Integrate [Google Authenticator PAM](https://github.com/google/google-authenticator)
    ```bash
    sudo apt install libpam-google-authenticator
    ```
    Add to `/etc/pam.d/sshd`:
    ```
    auth required pam_google_authenticator.so
    ```

_Best Practice:_  
Use PAM for granular SSH session controls, compliance, and MFA.

### E. Monitoring SSH Daemon with Prometheus Exporters

- Install [prometheus-sshd-exporter](https://github.com/caarlos0/prometheus-sshd-exporter) or similar.
- Exposes SSH login metrics (auth attempts, failures, active sessions).
- Example systemd service:
  ```bash
  [Unit]
  Description=Prometheus SSHD Exporter
  [Service]
  ExecStart=/usr/local/bin/sshd_exporter --listen-address=:9119
  [Install]
  WantedBy=multi-user.target
  ```
- Scrape with Prometheus, alert on anomalies in Grafana.

_Best Practice:_  
Integrate SSH metrics into central monitoring for security and operational insight.

---

## Security & Best Practices Summary

| Area             | Recommendation                                                |
|------------------|--------------------------------------------------------------|
| SSH Access       | Use key-based login, disable root, restrict allowed users     |
| Bastion/Jump     | Centralize access, use ProxyJump, audit all connections      |
| Certificates     | Issue short-lived certs, automate CA/key rotation            |
| Passwords        | Enforce strong policy, rotate regularly                      |
| Firewall         | Default-deny, open only required ports                       |
| Sudo             | Use visudo, least privilege, restrict commands/groups        |
| PAM              | Restrict sessions, enforce MFA, audit usage                  |
| Automation       | Use config management for enforcement                        |
| Monitoring       | Integrate Fail2Ban, Prometheus, audit SSH logs               |
| Key Management   | Use centralized vaults, automate rotation                    |
| Compliance       | Regular audits, SIEM integration, session logging            |

---

## Cheat Sheet

```bash
# SSH connect
ssh user@host
ssh -p 2222 user@host

# Bastion/jump host
ssh -J bastion-host internal
# or ~/.ssh/config with ProxyJump

# Generate SSH key
ssh-keygen -t ed25519 -a 100

# Copy key to remote
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@host

# Disable password login
sudo vi /etc/ssh/sshd_config
# Set PasswordAuthentication no

# Transfer files
scp -P 2222 /local/file user@host:/remote/path
rsync -avz -e "ssh -p 2222" /local/dir/ user@host:/remote/dir/

# Firewall
sudo iptables -A INPUT -p tcp --dport 2222 -j ACCEPT
sudo iptables -A INPUT -j DROP
sudo iptables-save | sudo tee /etc/iptables/rules.v4

# Password complexity
sudo apt install libpam-pwquality
sudo vi /etc/security/pwquality.conf

# Sudo privileges
sudo visudo

# Fail2Ban
sudo apt install fail2ban
sudo systemctl enable --now fail2ban

# SSH CA short-lived certificate
ssh-keygen -s /path/to/ca_key -I user -n username -V +1h ~/.ssh/id_ed25519.pub

# PAM Google Authenticator
sudo apt install libpam-google-authenticator
sudo google-authenticator

# Prometheus SSHD Exporter
sshd_exporter --listen-address=:9119
```

---

## References

- `man ssh`, `man sshd_config`, `man scp`, `man rsync`, `man iptables`, `man visudo`
- [OpenSSH](https://www.openssh.com/manual.html)
- [PuTTY](https://www.putty.org/)
- [Fail2Ban](https://www.fail2ban.org/wiki/index.php/Main_Page)
- [pam_pwquality](https://linux.die.net/man/8/pam_pwquality)
- [Ansible SSH Hardening Role](https://github.com/dev-sec/ansible-ssh-hardening)
- [HashiCorp Vault SSH Secrets](https://developer.hashicorp.com/vault/tutorials/secrets-management/ssh-secrets)
- [AWS EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html)
- [Azure Key Vault](https://learn.microsoft.com/en-us/azure/key-vault/general/overview)
- [Google Authenticator PAM](https://github.com/google/google-authenticator)
- [OpenSSH Certificate Authentication](https://man.openbsd.org/ssh-keygen#CERTIFICATES)
- [Prometheus SSHD Exporter](https://github.com/caarlos0/prometheus-sshd-exporter)
- [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html)
- [Azure Bastion](https://learn.microsoft.com/en-us/azure/bastion/bastion-overview)
- [GCP IAP TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding)
---

_Best Practice:_  
Automate SSH configuration, enforce key-based authentication, harden all remote access, and integrate monitoring, vaults, auditing, session management, and compliance tools for enterprise-grade security.

---
