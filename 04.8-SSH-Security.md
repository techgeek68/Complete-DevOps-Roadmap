# 14. Remote Login Using SSH, Security, and Security Hardening

This section covers secure remote access with SSH, key-based authentication, file transfer, and system hardening practices for DevOps engineers. It includes advanced configuration, automation, firewall, sudo, password policies, best practices for Linux/cloud/enterprise environments, and additional advanced/enterprise topics.

---

## 14.1 Configuring SSH for Secure Remote Access

**SSH (Secure Shell)** encrypts traffic for safe remote administration.

### Prerequisites
- Two VMs: **Web Server** and **Web Developer**
- On ‘Web Developer’:
  ```bash
  mkdir developerfile
  cd developerfile
  vim index.html
  # <h1> testing SSH connection </h1>
  ```

### A. Basic SSH Connection

- **Linux/MacOS:** Pre-installed. Use `ssh` in terminal.
- **Windows:** OpenSSH (Windows 10/11), or [PuTTY](https://www.putty.org/) for older versions.

**Connect (default port):**
```bash
ssh user_name@remote_host
```

**Connect (custom port):**
1. On server, edit `/etc/ssh/sshd_config`:
    ```
    Port 2222
    PermitRootLogin no
    AllowUsers your_username
    ```
2. Register port with SELinux (if enabled):
    ```bash
    sudo semanage port -a -t ssh_port_t -p tcp 2222
    ```
3. Configure firewall:
    ```bash
    sudo firewall-cmd --permanent --add-port=2222/tcp
    sudo firewall-cmd --reload
    ```
4. Reload SSH:
    ```bash
    sudo systemctl reload sshd
    ```
5. Connect:
    ```bash
    ssh -p 2222 user@remote_host_IP
    ```

### B. SSH Client Aliases (`~/.ssh/config`)
Example:
```
Host testserver
    HostName 192.168.1.100
    User cnode
    Port 2222
Host prod
    HostName 10.0.0.1
    User admin
Host dev
    HostName 192.168.1.101
    User coder
Host db-tunnel
    HostName db.example.com
    LocalForward 3306 127.0.0.1:3306
```
- Connect with:
    ```bash
    ssh testserver
    ```
_Best Practice:_  
Organize servers, automate tunnels, simplify connections.

---

## 14.2 Key-Based Authentication

**Generate SSH Keys:**
- **RSA (legacy):**  
  ```bash
  ssh-keygen -t rsa -b 4096
  ```
- **ED25519 (modern, recommended):**
  ```bash
  ssh-keygen -t ed25519 -a 100
  ```
  - `-a 100`: Key derivation rounds for brute-force resistance

**Keys stored at:**
- Private: `~/.ssh/id_ed25519`
- Public: `~/.ssh/id_ed25519.pub`

**Copy Public Key to Remote:**
```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@remote_server_IP
```
**Disable Password Authentication (on server):**
Edit `/etc/ssh/sshd_config`:
```
PasswordAuthentication no
ChallengeResponseAuthentication no
UsePAM no
```
Reload SSH:
```bash
sudo systemctl reload sshd
```
**Connect Using Key:**
```bash
ssh -i ~/.ssh/id_ed25519 username@remote_server_ip
```

_Best Practice:_  
Always use key-based login; disable password login for production.

---

## 14.3 File Transfers Over SSH

### A. Using `scp`
- **Local → Remote:**
  ```bash
  scp /local/path/file.txt username@remote_server_ip:/remote/path/
  ```
- **Remote → Local:**
  ```bash
  scp username@remote_server_ip:/remote/path/file.txt /local/path/
  ```
- **Custom port:**
  ```bash
  scp -P 2222 /local/file username@remote_server_ip:/remote/path/
  ```
- **Recursive:**
  ```bash
  scp -r /local/dir username@remote_server_ip:/remote/dir
  ```

### B. Using `rsync`
- **Sync directories:**
  ```bash
  rsync -avz /local/dir/ user@remote_host:/remote/dir/
  ```
- **Mirror directories (delete extraneous files):**
  ```bash
  rsync -avz --delete /local/dir/ user@remote_host:/remote/dir/
  ```
- **Custom port:**
  ```bash
  rsync -avz -e "ssh -p 2222" /local/dir/ username@remote_server_ip:/remote/dir/
  ```
- **Flags:**
  - `-a`: Archive mode
  - `-v`: Verbose
  - `-z`: Compress
  - `-e`: Specify remote shell/port

_Best Practice:_  
Use `rsync` for large or repeated transfers; automate with scripts.

---

## 15.1 Security and Hardening

### A. SSH Hardening

- **Disable Root Login:**
  Edit `/etc/ssh/sshd_config`:
  ```
  PermitRootLogin no
  ```
- **Change Default Port:**
  ```
  Port 2222
  ```
- **Limit Allowed Users:**
  ```
  AllowUsers alice bob
  ```

- **Fail2Ban (anti-brute-force):**
  - **Debian/Ubuntu:**  
    `sudo apt install fail2ban`
  - **RHEL/CentOS:**  
    `sudo dnf install fail2ban`
  - Monitors logs and bans IPs with suspicious activity.

_Best Practice:_  
Always restrict root login, limit allowed users, and use Fail2Ban for SSH.

---

### B. Basic Firewall with iptables

**Allow SSH (custom port):**
```bash
sudo iptables -A INPUT -p tcp --dport 2222 -j ACCEPT
```
**Allow HTTP/HTTPS:**
```bash
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```
**Block all other incoming:**
```bash
sudo iptables -A INPUT -j DROP
```
**Persist Rules:**
```bash
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```
**Check Rules:**
```bash
sudo iptables -L -v
```

_Best Practice:_  
Default-deny policy; only open required ports.

---

### C. Strong Passwords and sudo

- **Enforce Strong Passwords:**
  - **Debian/Ubuntu:**  
    `sudo apt install libpam-pwquality`
  - **RHEL/CentOS:**  
    `sudo dnf install libpwquality`
  - Configure `/etc/security/pwquality.conf`

- **Configure sudo:**
  - Edit with `visudo` for safety:
    ```
    david ALL=(ALL:ALL) ALL
    # Restrict to specific commands
    david ALL=/usr/sbin/useradd, /usr/sbin/userdel
    # Group-based
    %admins ALL=(ALL) /usr/bin/systemctl restart nginx
    ```

_Best Practice:_  
Never use weak or default passwords. Use the principle of least privilege for sudo.

---

## Advanced/Enterprise Enhancements

### A. Bastion Host / Jump Host Setup

- Use a dedicated bastion host as a secure entry point to private servers in multi-tier environments.
- Restrict SSH access to production/internal servers from outside only via the bastion.
- Example `/etc/ssh/sshd_config` for bastion:
  ```
  AllowTcpForwarding yes
  PermitTunnel yes
  ```
- Use ProxyJump/ProxyCommand in `~/.ssh/config`:
  ```bash
  Host internal
    HostName 10.0.0.10
    User admin
    ProxyJump bastion-host
  ```
  or
  ```bash
  ssh -J bastion-host internal
  ```
- Harden bastion: restrict IPs, enforce key-based auth, enable logging/auditing.

### B. Automated SSH Certificate Authorities (CA)

- Use OpenSSH CA to issue short-lived certificates for users/hosts.
- Benefits: central control, key rotation, short-lived credentials.
- Example to sign a user key:
  ```bash
  ssh-keygen -s /path/to/ca_key -I user -n username -V +1h ~/.ssh/id_ed25519.pub
  ```
- Add CA public key to `/etc/ssh/sshd_config`:
  ```
  TrustedUserCAKeys /etc/ssh/ca.pub
  ```
- Automate with Vault, Teleport, or AWS IAM SSH certificates.

### C. Cloud-Native SSH Session Auditing

- **AWS:** Use [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html) for shell access with audit logs and no direct SSH port exposure.
- **Azure:** Use [Azure Bastion](https://learn.microsoft.com/en-us/azure/bastion/bastion-overview) for secure, audited SSH/RDP.
- **GCP:** Use [IAP TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding) and OS Login for SSH session logging.

_Best Practice:_  
Prefer cloud-native session management for audit/compliance and no key management.

### D. Advanced PAM Modules for SSH Restriction

- Use PAM modules to restrict SSH sessions by time, IP, user, or MFA.
- Example for time-based restrictions:
  - Edit `/etc/security/time.conf`
- Example for multi-factor authentication:
  - Integrate [Google Authenticator PAM](https://github.com/google/google-authenticator)
    ```bash
    sudo apt install libpam-google-authenticator
    ```
    Add to `/etc/pam.d/sshd`:
    ```
    auth required pam_google_authenticator.so
    ```

_Best Practice:_  
Use PAM for granular SSH session controls, compliance, and MFA.

### E. Monitoring SSH Daemon with Prometheus Exporters

- Install [prometheus-sshd-exporter](https://github.com/caarlos0/prometheus-sshd-exporter) or similar.
- Exposes SSH login metrics (auth attempts, failures, active sessions).
- Example systemd service:
  ```bash
  [Unit]
  Description=Prometheus SSHD Exporter
  [Service]
  ExecStart=/usr/local/bin/sshd_exporter --listen-address=:9119
  [Install]
  WantedBy=multi-user.target
  ```
- Scrape with Prometheus, alert on anomalies in Grafana.

_Best Practice:_  
Integrate SSH metrics into central monitoring for security and operational insight.

---

## Security & Best Practices Summary

| Area             | Recommendation                                                |
|------------------|--------------------------------------------------------------|
| SSH Access       | Use key-based login, disable root, restrict allowed users     |
| Bastion/Jump     | Centralize access, use ProxyJump, audit all connections      |
| Certificates     | Issue short-lived certs, automate CA/key rotation            |
| Passwords        | Enforce strong policy, rotate regularly                      |
| Firewall         | Default-deny, open only required ports                       |
| Sudo             | Use visudo, least privilege, restrict commands/groups        |
| PAM              | Restrict sessions, enforce MFA, audit usage                  |
| Automation       | Use config management for enforcement                        |
| Monitoring       | Integrate Fail2Ban, Prometheus, audit SSH logs               |
| Key Management   | Use centralized vaults, automate rotation                    |
| Compliance       | Regular audits, SIEM integration, session logging            |

---

## Cheat Sheet

```bash
# SSH connect
ssh user@host
ssh -p 2222 user@host

# Bastion/jump host
ssh -J bastion-host internal
# or ~/.ssh/config with ProxyJump

# Generate SSH key
ssh-keygen -t ed25519 -a 100

# Copy key to remote
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@host

# Disable password login
sudo vi /etc/ssh/sshd_config
# Set PasswordAuthentication no

# Transfer files
scp -P 2222 /local/file user@host:/remote/path
rsync -avz -e "ssh -p 2222" /local/dir/ user@host:/remote/dir/

# Firewall
sudo iptables -A INPUT -p tcp --dport 2222 -j ACCEPT
sudo iptables -A INPUT -j DROP
sudo iptables-save | sudo tee /etc/iptables/rules.v4

# Password complexity
sudo apt install libpam-pwquality
sudo vi /etc/security/pwquality.conf

# Sudo privileges
sudo visudo

# Fail2Ban
sudo apt install fail2ban
sudo systemctl enable --now fail2ban

# SSH CA short-lived certificate
ssh-keygen -s /path/to/ca_key -I user -n username -V +1h ~/.ssh/id_ed25519.pub

# PAM Google Authenticator
sudo apt install libpam-google-authenticator
sudo google-authenticator

# Prometheus SSHD Exporter
sshd_exporter --listen-address=:9119
```

---

## References

- `man ssh`, `man sshd_config`, `man scp`, `man rsync`, `man iptables`, `man visudo`
- [OpenSSH](https://www.openssh.com/manual.html)
- [PuTTY](https://www.putty.org/)
- [Fail2Ban](https://www.fail2ban.org/wiki/index.php/Main_Page)
- [pam_pwquality](https://linux.die.net/man/8/pam_pwquality)
- [Ansible SSH Hardening Role](https://github.com/dev-sec/ansible-ssh-hardening)
- [HashiCorp Vault SSH Secrets](https://developer.hashicorp.com/vault/tutorials/secrets-management/ssh-secrets)
- [AWS EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html)
- [Azure Key Vault](https://learn.microsoft.com/en-us/azure/key-vault/general/overview)
- [Google Authenticator PAM](https://github.com/google/google-authenticator)
- [OpenSSH Certificate Authentication](https://man.openbsd.org/ssh-keygen#CERTIFICATES)
- [Prometheus SSHD Exporter](https://github.com/caarlos0/prometheus-sshd-exporter)
- [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html)
- [Azure Bastion](https://learn.microsoft.com/en-us/azure/bastion/bastion-overview)
- [GCP IAP TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding)
---

_Best Practice:_  
Automate SSH configuration, enforce key-based authentication, harden all remote access, and integrate monitoring, vaults, auditing, session management, and compliance tools for enterprise-grade security.

---
